<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Posts on </title>
    <link>https://KTS-o7.github.io/bear/posts/</link>
    <description>Recent content in Posts on </description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <managingEditor>shentharkrishnatejaswi@gmail.com (Krishnatejaswi S)</managingEditor>
    <webMaster>shentharkrishnatejaswi@gmail.com (Krishnatejaswi S)</webMaster>
    <copyright>Krishnatejaswi S</copyright>
    <lastBuildDate>Sat, 27 Dec 2025 00:00:00 +0530</lastBuildDate>
    <atom:link href="https://KTS-o7.github.io/bear/posts/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>End-to-End HTTPS with Cloudflare Origin Certificates and Nginx</title>
      <link>https://KTS-o7.github.io/bear/posts/reverse_proxy/</link>
      <pubDate>Sat, 27 Dec 2025 00:00:00 +0530</pubDate><author>shentharkrishnatejaswi@gmail.com (Krishnatejaswi S)</author>
      <guid>https://KTS-o7.github.io/bear/posts/reverse_proxy/</guid>
      <description>&lt;p&gt;Setting up proper SSL/TLS for your web application can be confusing, especially when Cloudflare is in the picture. This guide walks through configuring end-to-end encryption from browser to origin server using Cloudflare Origin Certificates with an Nginx reverse proxy running in Docker.&lt;/p&gt;&#xA;&lt;hr&gt;&#xA;&lt;h3 id=&#34;the-problem-cloudflare-521-errors&#34;&gt;The Problem: Cloudflare 521 Errors&lt;/h3&gt;&#xA;&lt;p&gt;If you&amp;rsquo;re running Nginx behind Cloudflare and seeing &lt;strong&gt;521 errors&lt;/strong&gt;, you likely have a mismatch between your Cloudflare SSL mode and what your origin server supports.&lt;/p&gt;</description>
      <content:encoded><![CDATA[<p>Setting up proper SSL/TLS for your web application can be confusing, especially when Cloudflare is in the picture. This guide walks through configuring end-to-end encryption from browser to origin server using Cloudflare Origin Certificates with an Nginx reverse proxy running in Docker.</p>
<hr>
<h3 id="the-problem-cloudflare-521-errors">The Problem: Cloudflare 521 Errors</h3>
<p>If you&rsquo;re running Nginx behind Cloudflare and seeing <strong>521 errors</strong>, you likely have a mismatch between your Cloudflare SSL mode and what your origin server supports.</p>
<p><strong>Common scenario:</strong></p>
<ul>
<li>Nginx is only listening on port 80 (HTTP)</li>
<li>Cloudflare SSL mode is set to &ldquo;Full&rdquo; or &ldquo;Full (Strict)&rdquo;</li>
<li>Cloudflare tries to connect to your origin on port 443</li>
<li>Origin doesn&rsquo;t respond → <strong>521 Error</strong></li>
</ul>
<p><a href="https://mermaid.live/edit#pako:eNplkE1qwzAQha9izNqOZUm2ZAdCnEJ3XXVVvBjLk1jEP0GSQ0Lw3avYpIvOaoZ5H_N4C8i2IshgaPlQ-5x2bum6i-_PvBp4NfmUjWaINofejGeySrXlpZnlZJy8zFfh6G3P_U3-YkCMt_JNJbzTZCz3r-bLdkZOlRQ8Dab3_JYvq9LJ67gHb0fHf7x3Xo9yPAz8ZthZKe8G7ozrLO_F5zd4M8xBBLJiO9qBMvDbsqaEgvYtFKAXr4MSattz1tBh0n4DJYxdw5mz2hicMujV-OfCEzIn-wZS0qTzFDLXrTfOlWdIf6D4AQP0bwI"><img src="https://mermaid.ink/img/pako:eNplkE1qwzAQha9izNqOZUm2ZAdCnEJ3XXVVvBjLk1jEP0GSQ0Lw3avYpIvOaoZ5H_N4C8i2IshgaPlQ-5x2bum6i-_PvBp4NfmUjWaINofejGeySrXlpZnlZJy8zFfh6G3P_U3-YkCMt_JNJbzTZCz3r-bLdkZOlRQ8Dab3_JYvq9LJ67gHb0fHf7x3Xo9yPAz8ZthZKe8G7ozrLO_F5zd4M8xBBLJiO9qBMvDbsqaEgvYtFKAXr4MSattz1tBh0n4DJYxdw5mz2hicMujV-OfCEzIn-wZS0qTzFDLXrTfOlWdIf6D4AQP0bwI?type=png" alt=""></a></p>
<hr>
<h3 id="understanding-cloudflare-ssltls-modes">Understanding Cloudflare SSL/TLS Modes</h3>
<p>Cloudflare offers four SSL modes. Understanding these is crucial:</p>
<table>
  <thead>
      <tr>
          <th>Mode</th>
          <th>Browser → Cloudflare</th>
          <th>Cloudflare → Origin</th>
          <th>Certificate Validation</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>Off</strong></td>
          <td>HTTP</td>
          <td>HTTP</td>
          <td>None</td>
      </tr>
      <tr>
          <td><strong>Flexible</strong></td>
          <td>HTTPS ✅</td>
          <td>HTTP</td>
          <td>None</td>
      </tr>
      <tr>
          <td><strong>Full</strong></td>
          <td>HTTPS ✅</td>
          <td>HTTPS ✅</td>
          <td>Accepts any certificate</td>
      </tr>
      <tr>
          <td><strong>Full (Strict)</strong></td>
          <td>HTTPS ✅</td>
          <td>HTTPS ✅</td>
          <td>Validates certificate ✅</td>
      </tr>
  </tbody>
</table>
<p><strong>Key differences:</strong></p>
<ul>
<li>
<p><strong>Flexible</strong>: Quick fix if your origin can&rsquo;t do HTTPS, but traffic between Cloudflare and your server is unencrypted — vulnerable to MITM attacks on that leg.</p>
</li>
<li>
<p><strong>Full</strong>: Encrypts both legs, but accepts <em>any</em> certificate (even self-signed, expired, or attacker-provided). Provides encryption but not authentication.</p>
</li>
<li>
<p><strong>Full (Strict)</strong>: The gold standard. Cloudflare validates that your origin certificate is either:</p>
<ul>
<li>A valid public CA certificate</li>
<li>A Cloudflare Origin Certificate</li>
</ul>
<p>This prevents MITM attacks where an attacker presents a fake certificate.</p>
</li>
</ul>
<hr>
<h3 id="architecture-overview">Architecture Overview</h3>
<p>Our target architecture:</p>





<pre tabindex="0"><code>┌──────────────────────────────────────────────────────────────────────┐
│                          INTERNET                                    │
└──────────────────────────┬───────────────────────────────────────────┘
                           │ HTTPS (443)
                           ▼
┌──────────────────────────────────────────────────────────────────────┐
│                     CLOUDFLARE EDGE                                  │
│              (SSL Termination + CDN + WAF)                           │
└──────────────────────────┬───────────────────────────────────────────┘
                           │ HTTPS (443) - Origin Certificate
                           ▼
┌──────────────────────────────────────────────────────────────────────┐
│                    YOUR EC2 INSTANCE                                 │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │                    DOCKER NETWORK                               │ │
│  │                                                                 │ │
│  │   ┌─────────────┐    HTTP    ┌─────────────────────────────┐    │ │
│  │   │   NGINX     │───────────▶│     APPLICATION CONTAINERS  │    │ │
│  │   │  (SSL/443)  │            │  - Frontend (Next.js:3000)  │    │ │
│  │   │  (80→443)   │            │  - Backend (FastAPI:8000)   │    │ │
│  │   └─────────────┘            │  - Cloud APIs               │    │ │
│  │         ▲                    └─────────────────────────────┘    │ │
│  │         │                                                       │ │
│  └─────────┼───────────────────────────────────────────────────────┘ │
│            │                                                         │
│     Ports 80, 443                                                    │
└──────────────────────────────────────────────────────────────────────┘</code></pre><p><strong>Traffic flow:</strong></p>
<ol>
<li>Browser connects to Cloudflare over HTTPS (public SSL certificate)</li>
<li>Cloudflare connects to your origin over HTTPS (Origin Certificate)</li>
<li>Nginx terminates SSL and proxies to backend containers over HTTP</li>
<li>Backend containers communicate on internal Docker network (isolated)</li>
</ol>
<hr>
<h3 id="prerequisites">Prerequisites</h3>
<p>Before starting, ensure you have:</p>
<ul>
<li>A domain proxied through Cloudflare (orange cloud enabled)</li>
<li>Docker and Docker Compose installed on your server</li>
<li>An existing Nginx configuration (we&rsquo;ll modify it)</li>
<li>Access to Cloudflare dashboard</li>
<li><strong>Firewall Rules</strong>: Ensure ports 80 and 443 are open in your cloud provider&rsquo;s firewall (AWS Security Group, etc.)</li>
</ul>
<hr>
<h3 id="step-1-generate-a-cloudflare-origin-certificate">Step 1: Generate a Cloudflare Origin Certificate</h3>
<p>Cloudflare Origin Certificates are free, trusted only by Cloudflare, and can be valid for up to 15 years.</p>
<ol>
<li>Log into <a href="https://dash.cloudflare.com">Cloudflare Dashboard</a></li>
<li>Select your domain</li>
<li>Navigate to <strong>SSL/TLS</strong> → <strong>Origin Server</strong></li>
<li>Click <strong>Create Certificate</strong></li>
<li>Configure:
<ul>
<li><strong>Private key type</strong>: RSA (2048)</li>
<li><strong>Hostnames</strong>: <code>*.yourdomain.com, yourdomain.com</code></li>
<li><strong>Validity</strong>: 15 years (recommended)</li>
</ul>
</li>
<li>Click <strong>Create</strong></li>
</ol>
<p><strong>⚠️ IMPORTANT</strong>: Copy both the <strong>Origin Certificate</strong> (PEM) and <strong>Private Key</strong> immediately. The private key is shown only once!</p>
<p>Save them to files:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># Create SSL directory</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">mkdir -p ssl
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="c1"># Paste the certificate</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">cat &gt; ssl/origin.pem <span class="s">&lt;&lt; &#39;EOF&#39;
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="s">-----BEGIN CERTIFICATE-----
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="s">YOUR_CERTIFICATE_HERE
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="s">-----END CERTIFICATE-----
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="c1"># Paste the private key</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">cat &gt; ssl/origin.key <span class="s">&lt;&lt; &#39;EOF&#39;
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="s">-----BEGIN PRIVATE KEY-----
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="s">YOUR_PRIVATE_KEY_HERE
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="s">-----END PRIVATE KEY-----
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="c1"># Set secure permissions</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">chmod <span class="m">600</span> ssl/origin.key
</span></span><span class="line"><span class="ln">20</span><span class="cl">chmod <span class="m">644</span> ssl/origin.pem</span></span></code></pre></div><p>Add to <code>.gitignore</code> to never commit these:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;ssl/*&#34;</span> &gt;&gt; .gitignore</span></span></code></pre></div><hr>
<h3 id="step-2-configure-nginx-for-https">Step 2: Configure Nginx for HTTPS</h3>
<p>Here&rsquo;s a complete Nginx configuration with SSL, security headers, rate limiting, and reverse proxy setup.</p>
<p><strong><code>nginx/nginx-main.conf</code></strong> - Main HTTP block configuration:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># Main nginx configuration with security settings
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1"></span><span class="k">user</span> <span class="s">nginx</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="k">worker_processes</span> <span class="s">auto</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="k">error_log</span> <span class="s">/var/log/nginx/error.log</span> <span class="s">warn</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="k">pid</span> <span class="s">/var/run/nginx.pid</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="k">events</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="kn">worker_connections</span> <span class="mi">1024</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="kn">use</span> <span class="s">epoll</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="kn">multi_accept</span> <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="k">http</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="kn">include</span> <span class="s">/etc/nginx/mime.types</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">    <span class="kn">default_type</span> <span class="s">application/octet-stream</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">
</span></span><span class="line"><span class="ln">17</span><span class="cl">    <span class="c1"># Logging format with security information
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="c1"></span>    <span class="kn">log_format</span> <span class="s">security</span> <span class="s">&#39;</span><span class="nv">$real_ip</span> <span class="s">-</span> <span class="nv">$remote_user</span> <span class="s">[</span><span class="nv">$time_local]</span> <span class="s">&#34;</span><span class="nv">$request&#34;</span> <span class="s">&#39;</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">                       <span class="s">&#39;</span><span class="nv">$status</span> <span class="nv">$body_bytes_sent</span> <span class="s">&#34;</span><span class="nv">$http_referer&#34;</span> <span class="s">&#39;</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">                       <span class="s">&#39;&#34;</span><span class="nv">$http_user_agent&#34;</span> <span class="s">&#34;</span><span class="nv">$http_x_forwarded_for&#34;</span> <span class="s">&#39;</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">                       <span class="s">&#39;rt=</span><span class="nv">$request_time</span> <span class="s">uct=&#34;</span><span class="nv">$upstream_connect_time&#34;</span> <span class="s">&#39;</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">                       <span class="s">&#39;uht=&#34;</span><span class="nv">$upstream_header_time&#34;</span> <span class="s">urt=&#34;</span><span class="nv">$upstream_response_time&#34;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">
</span></span><span class="line"><span class="ln">24</span><span class="cl">    <span class="kn">access_log</span> <span class="s">/var/log/nginx/access.log</span> <span class="s">security</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">
</span></span><span class="line"><span class="ln">26</span><span class="cl">    <span class="c1"># Pro Tip: use $real_ip in log_format so you see actual visitor IPs, not Cloudflare&#39;s.
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">    <span class="c1"># Basic settings
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="c1"></span>    <span class="kn">sendfile</span> <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">    <span class="kn">tcp_nopush</span> <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">    <span class="kn">tcp_nodelay</span> <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">    <span class="kn">keepalive_timeout</span> <span class="mi">65</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">    <span class="kn">types_hash_max_size</span> <span class="mi">2048</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">    <span class="kn">server_tokens</span> <span class="no">off</span><span class="p">;</span>  <span class="c1"># Hide nginx version
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">    <span class="c1"># Gzip compression
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="c1"></span>    <span class="kn">gzip</span> <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">    <span class="kn">gzip_vary</span> <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">    <span class="kn">gzip_proxied</span> <span class="s">any</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">    <span class="kn">gzip_comp_level</span> <span class="mi">6</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">    <span class="kn">gzip_types</span> <span class="s">text/plain</span> <span class="s">text/css</span> <span class="s">text/xml</span> <span class="s">text/javascript</span> 
</span></span><span class="line"><span class="ln">42</span><span class="cl">               <span class="s">application/json</span> <span class="s">application/javascript</span> <span class="s">application/xml+rss</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">
</span></span><span class="line"><span class="ln">44</span><span class="cl">    <span class="c1"># Rate limiting zones
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="c1"></span>    <span class="kn">limit_req_zone</span> <span class="nv">$binary_remote_addr</span> <span class="s">zone=general_limit:10m</span> <span class="s">rate=50r/s</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">    <span class="kn">limit_req_zone</span> <span class="nv">$binary_remote_addr</span> <span class="s">zone=api_limit:10m</span> <span class="s">rate=30r/s</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl">    <span class="kn">limit_req_zone</span> <span class="nv">$binary_remote_addr</span> <span class="s">zone=burst_limit:10m</span> <span class="s">rate=200r/m</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl">    <span class="kn">limit_conn_zone</span> <span class="nv">$binary_remote_addr</span> <span class="s">zone=conn_limit:10m</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl">
</span></span><span class="line"><span class="ln">50</span><span class="cl">    <span class="kn">include</span> <span class="s">/etc/nginx/conf.d/*.conf</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="p">}</span></span></span></code></pre></div><p><strong><code>nginx/nginx.conf</code></strong> - Server block configuration with SSL:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="ln">  1</span><span class="cl"><span class="c1"># Cloudflare IP handling - extract real client IP
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="c1"></span><span class="k">map</span> <span class="nv">$http_cf_connecting_ip</span> <span class="nv">$real_ip</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">  3</span><span class="cl">    <span class="kn">&#34;&#34;</span> <span class="nv">$remote_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">  4</span><span class="cl">    <span class="kn">default</span> <span class="nv">$http_cf_connecting_ip</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">  6</span><span class="cl">
</span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="c1"># Cloudflare protocol handling
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="c1"></span><span class="k">map</span> <span class="nv">$http_x_forwarded_proto</span> <span class="nv">$forwarded_proto</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">  9</span><span class="cl">    <span class="kn">&#34;&#34;</span> <span class="nv">$scheme</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 10</span><span class="cl">    <span class="kn">default</span> <span class="nv">$http_x_forwarded_proto</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 12</span><span class="cl">
</span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="c1"># HTTP Server (Port 80) - Redirect to HTTPS
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="c1"></span><span class="k">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 15</span><span class="cl">    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 16</span><span class="cl">    <span class="kn">server_name</span> <span class="s">_</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 17</span><span class="cl">
</span></span><span class="line"><span class="ln"> 18</span><span class="cl">    <span class="c1"># Health check (keep on port 80 for internal monitoring)
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="c1"></span>    <span class="kn">location</span> <span class="s">/health</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 20</span><span class="cl">        <span class="kn">access_log</span> <span class="no">off</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 21</span><span class="cl">        <span class="kn">return</span> <span class="mi">200</span> <span class="s">&#34;healthy\n&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 22</span><span class="cl">        <span class="kn">add_header</span> <span class="s">Content-Type</span> <span class="s">text/plain</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 23</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln"> 24</span><span class="cl">
</span></span><span class="line"><span class="ln"> 25</span><span class="cl">    <span class="c1"># Redirect all other traffic to HTTPS
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="c1"></span>    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 27</span><span class="cl">        <span class="kn">return</span> <span class="mi">301</span> <span class="s">https://</span><span class="nv">$host$request_uri</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 28</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 30</span><span class="cl">
</span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="c1"># HTTPS Server (Port 443)
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="c1"></span><span class="k">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 33</span><span class="cl">    <span class="kn">listen</span> <span class="mi">443</span> <span class="s">ssl</span> <span class="s">http2</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 34</span><span class="cl">    <span class="kn">server_name</span> <span class="s">_</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 35</span><span class="cl">
</span></span><span class="line"><span class="ln"> 36</span><span class="cl">    <span class="c1"># SSL Configuration - Cloudflare Origin Certificate
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="c1"></span>    <span class="kn">ssl_certificate</span> <span class="s">/etc/nginx/ssl/origin.pem</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 38</span><span class="cl">    <span class="kn">ssl_certificate_key</span> <span class="s">/etc/nginx/ssl/origin.key</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 39</span><span class="cl">    
</span></span><span class="line"><span class="ln"> 40</span><span class="cl">    <span class="c1"># Modern SSL settings
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="c1"></span>    <span class="kn">ssl_protocols</span> <span class="s">TLSv1.2</span> <span class="s">TLSv1.3</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 42</span><span class="cl">    <span class="kn">ssl_ciphers</span> <span class="s">ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 43</span><span class="cl">    <span class="kn">ssl_prefer_server_ciphers</span> <span class="no">off</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 44</span><span class="cl">    <span class="kn">ssl_session_timeout</span> <span class="s">1d</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 45</span><span class="cl">    <span class="kn">ssl_session_cache</span> <span class="s">shared:SSL:10m</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 46</span><span class="cl">    <span class="kn">ssl_session_tickets</span> <span class="no">off</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 47</span><span class="cl">
</span></span><span class="line"><span class="ln"> 48</span><span class="cl">    <span class="c1"># Connection and request limits
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="c1"></span>    <span class="kn">limit_conn</span> <span class="s">conn_limit</span> <span class="mi">100</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 50</span><span class="cl">    <span class="kn">client_max_body_size</span> <span class="s">50M</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 51</span><span class="cl">    <span class="kn">client_body_buffer_size</span> <span class="s">4M</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 52</span><span class="cl">
</span></span><span class="line"><span class="ln"> 53</span><span class="cl">    <span class="c1"># Timeout limits (prevent slowloris attacks)
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="c1"></span>    <span class="kn">client_body_timeout</span> <span class="s">10s</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 55</span><span class="cl">    <span class="kn">client_header_timeout</span> <span class="s">10s</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 56</span><span class="cl">    <span class="kn">send_timeout</span> <span class="s">10s</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 57</span><span class="cl">
</span></span><span class="line"><span class="ln"> 58</span><span class="cl">    <span class="c1"># Security headers
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="c1"></span>    <span class="kn">add_header</span> <span class="s">X-Frame-Options</span> <span class="s">&#34;SAMEORIGIN&#34;</span> <span class="s">always</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 60</span><span class="cl">    <span class="kn">add_header</span> <span class="s">X-Content-Type-Options</span> <span class="s">&#34;nosniff&#34;</span> <span class="s">always</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 61</span><span class="cl">    <span class="kn">add_header</span> <span class="s">X-XSS-Protection</span> <span class="s">&#34;1</span><span class="p">;</span> <span class="kn">mode=block&#34;</span> <span class="s">always</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 62</span><span class="cl">    <span class="kn">add_header</span> <span class="s">Referrer-Policy</span> <span class="s">&#34;strict-origin-when-cross-origin&#34;</span> <span class="s">always</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 63</span><span class="cl">    <span class="kn">add_header</span> <span class="s">Permissions-Policy</span> <span class="s">&#34;geolocation=(),</span> <span class="s">microphone=(),</span> <span class="s">camera=()&#34;</span> <span class="s">always</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 64</span><span class="cl">    <span class="kn">add_header</span> <span class="s">Content-Security-Policy</span> <span class="s">&#34;default-src</span> <span class="s">&#39;self&#39;</span><span class="p">;</span> <span class="kn">script-src</span> <span class="s">&#39;self&#39;</span> <span class="s">&#39;unsafe-inline&#39;</span> <span class="s">&#39;unsafe-eval&#39;</span><span class="p">;</span> <span class="kn">style-src</span> <span class="s">&#39;self&#39;</span> <span class="s">&#39;unsafe-inline&#39;</span><span class="p">;</span> <span class="kn">img-src</span> <span class="s">&#39;self&#39;</span> <span class="s">data:</span> <span class="s">https:</span><span class="p">;</span> <span class="kn">font-src</span> <span class="s">&#39;self&#39;</span> <span class="s">data:</span><span class="p">;</span> <span class="kn">connect-src</span> <span class="s">&#39;self&#39;</span> <span class="s">https:</span><span class="p">;</span> <span class="kn">frame-src</span> <span class="s">&#39;self&#39;</span><span class="p">;</span><span class="kn">&#34;</span> <span class="s">always</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 65</span><span class="cl">
</span></span><span class="line"><span class="ln"> 66</span><span class="cl">    <span class="c1"># Frontend - Next.js
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="c1"></span>    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 68</span><span class="cl">        <span class="kn">limit_req</span> <span class="s">zone=general_limit</span> <span class="s">burst=100</span> <span class="s">nodelay</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 69</span><span class="cl">        
</span></span><span class="line"><span class="ln"> 70</span><span class="cl">        <span class="kn">proxy_pass</span> <span class="s">http://frontend:3000</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 71</span><span class="cl">        <span class="kn">proxy_http_version</span> <span class="mi">1</span><span class="s">.1</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 72</span><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">Upgrade</span> <span class="nv">$http_upgrade</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 73</span><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">Connection</span> <span class="s">&#39;upgrade&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 74</span><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$host</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 75</span><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$real_ip</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 76</span><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$real_ip</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 77</span><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-Proto</span> <span class="nv">$forwarded_proto</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 78</span><span class="cl">        <span class="kn">proxy_cache_bypass</span> <span class="nv">$http_upgrade</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 79</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln"> 80</span><span class="cl">
</span></span><span class="line"><span class="ln"> 81</span><span class="cl">    <span class="c1"># Backend API
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="c1"></span>    <span class="kn">location</span> <span class="s">/api</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 83</span><span class="cl">        <span class="kn">limit_req</span> <span class="s">zone=api_limit</span> <span class="s">burst=50</span> <span class="s">nodelay</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 84</span><span class="cl">        
</span></span><span class="line"><span class="ln"> 85</span><span class="cl">        <span class="kn">proxy_pass</span> <span class="s">http://backend:8000</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 86</span><span class="cl">        <span class="kn">proxy_http_version</span> <span class="mi">1</span><span class="s">.1</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 87</span><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$host</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 88</span><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$real_ip</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 89</span><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$real_ip</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 90</span><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-Proto</span> <span class="nv">$forwarded_proto</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 91</span><span class="cl">        
</span></span><span class="line"><span class="ln"> 92</span><span class="cl">        <span class="c1"># Increased timeouts for long-running requests
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="c1"></span>        <span class="kn">proxy_connect_timeout</span> <span class="s">300s</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 94</span><span class="cl">        <span class="kn">proxy_send_timeout</span> <span class="s">300s</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 95</span><span class="cl">        <span class="kn">proxy_read_timeout</span> <span class="s">300s</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 96</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln"> 97</span><span class="cl">
</span></span><span class="line"><span class="ln"> 98</span><span class="cl">    <span class="c1"># Health check
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="c1"></span>    <span class="kn">location</span> <span class="s">/health</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">100</span><span class="cl">        <span class="kn">access_log</span> <span class="no">off</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">101</span><span class="cl">        <span class="kn">return</span> <span class="mi">200</span> <span class="s">&#34;healthy\n&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">102</span><span class="cl">        <span class="kn">add_header</span> <span class="s">Content-Type</span> <span class="s">text/plain</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">103</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="p">}</span></span></span></code></pre></div><blockquote>
<p><strong>Docker DNS Caveat</strong>: Nginx caches DNS records at startup. If your backend container restarts and gets a new IP, Nginx might start returning 502 errors. To prevent this, use Docker&rsquo;s internal resolver <code>resolver 127.0.0.11 valid=30s;</code> and variables for <code>proxy_pass</code> targets.</p></blockquote>
<hr>
<h3 id="step-3-update-dockerfile">Step 3: Update Dockerfile</h3>
<p>Update your Nginx Dockerfile to expose both ports:</p>
<p><strong><code>nginx/Dockerfile</code></strong>:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">FROM</span><span class="w"> </span><span class="s">nginx:alpine</span><span class="err">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="err"></span><span class="c"># Copy configurations</span><span class="err">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="err"></span><span class="k">COPY</span> nginx-main.conf /etc/nginx/nginx.conf<span class="err">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="err"></span><span class="k">COPY</span> nginx.conf /etc/nginx/conf.d/default.conf<span class="err">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="err"></span><span class="c"># Expose HTTP and HTTPS ports</span><span class="err">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="err"></span><span class="k">EXPOSE</span><span class="w"> </span><span class="s">80</span> <span class="m">443</span><span class="err">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="err"></span><span class="k">CMD</span> <span class="p">[</span><span class="s2">&#34;nginx&#34;</span><span class="p">,</span> <span class="s2">&#34;-g&#34;</span><span class="p">,</span> <span class="s2">&#34;daemon off;&#34;</span><span class="p">]</span></span></span></code></pre></div><hr>
<h3 id="step-4-update-docker-compose">Step 4: Update Docker Compose</h3>
<p>Mount the SSL certificates and expose port 443:</p>
<p><strong><code>docker-compose.yml</code></strong> (nginx service section):</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">  </span><span class="nt">nginx</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">./nginx</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l">Dockerfile</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">my-nginx</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l">unless-stopped</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">      </span>- <span class="s2">&#34;80:80&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">      </span>- <span class="s2">&#34;443:443&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">      </span>- <span class="l">frontend</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">      </span>- <span class="l">backend</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">      </span>- <span class="l">app-network</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">      </span>- <span class="l">./ssl:/etc/nginx/ssl:ro </span><span class="w"> </span><span class="c"># Read-only mount</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="nt">healthcheck</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">      </span><span class="nt">test</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;CMD&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;curl&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-f&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;http://localhost/health&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">      </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">30s</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">      </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l">10s</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">      </span><span class="nt">retries</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w"></span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">  </span><span class="nt">app-network</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l">bridge</span></span></span></code></pre></div><hr>
<h3 id="step-5-deploy">Step 5: Deploy</h3>
<p>Rebuild and deploy only the nginx container (zero downtime for other services):</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># Build the new nginx image</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">docker compose build nginx
</span></span><span class="line"><span class="ln">3</span><span class="cl">
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1"># Recreate nginx container without touching dependencies</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">docker compose up -d --no-deps nginx
</span></span><span class="line"><span class="ln">6</span><span class="cl">
</span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="c1"># Verify nginx is running</span>
</span></span><span class="line"><span class="ln">8</span><span class="cl">docker compose logs nginx --tail<span class="o">=</span><span class="m">20</span></span></span></code></pre></div><p>If you have a deploy script like <code>prod.sh</code>, you might need:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># If container name conflicts exist</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">docker stop my-nginx <span class="o">&amp;&amp;</span> docker rm my-nginx
</span></span><span class="line"><span class="ln">3</span><span class="cl">./prod.sh -d nginx</span></span></code></pre></div><hr>
<h3 id="step-6-enable-full-strict-mode-in-cloudflare">Step 6: Enable Full (Strict) Mode in Cloudflare</h3>
<p>Now that your origin supports HTTPS with a valid Origin Certificate:</p>
<ol>
<li>Go to <strong>Cloudflare Dashboard</strong> → <strong>SSL/TLS</strong> → <strong>Overview</strong></li>
<li>Change encryption mode from <code>Flexible</code> or <code>Full</code> to <strong><code>Full (Strict)</code></strong></li>
</ol>
<p>This change takes effect immediately.</p>
<hr>
<h3 id="step-7-verify">Step 7: Verify</h3>
<p>Test the connection:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">curl -I https://yourdomain.com</span></span></code></pre></div><p>Expected output shows HTTP/2 200 with Cloudflare and security headers:</p>





<pre tabindex="0"><code>HTTP/2 200 
server: cloudflare
x-frame-options: SAMEORIGIN
x-content-type-options: nosniff
content-security-policy: default-src &#39;self&#39;...
cf-ray: xxxxxxxx-XXX</code></pre><hr>
<h3 id="troubleshooting">Troubleshooting</h3>
<h4 id="521-error-web-server-is-down">521 Error (Web server is down)</h4>
<ul>
<li>Origin not listening on port 443</li>
<li>Firewall blocking port 443</li>
<li>Nginx failed to start (check certificate paths)</li>
</ul>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># Check nginx logs</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">docker compose logs nginx
</span></span><span class="line"><span class="ln">3</span><span class="cl">
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1"># Verify nginx config syntax</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">docker compose <span class="nb">exec</span> nginx nginx -t</span></span></code></pre></div><h4 id="525-error-ssl-handshake-failed">525 Error (SSL handshake failed)</h4>
<ul>
<li>Certificate/key mismatch</li>
<li>Invalid certificate format</li>
<li>Wrong file permissions</li>
</ul>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># Verify certificate and key match</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">openssl x509 -noout -modulus -in ssl/origin.pem <span class="p">|</span> openssl md5
</span></span><span class="line"><span class="ln">3</span><span class="cl">openssl rsa -noout -modulus -in ssl/origin.key <span class="p">|</span> openssl md5
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1"># Both should output the same MD5 hash</span></span></span></code></pre></div><h4 id="526-error-invalid-ssl-certificate">526 Error (Invalid SSL certificate)</h4>
<ul>
<li>Only occurs in Full (Strict) mode</li>
<li>Origin certificate not trusted by Cloudflare</li>
<li>Certificate expired or for wrong hostname</li>
</ul>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># Check certificate details</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">openssl x509 -in ssl/origin.pem -text -noout <span class="p">|</span> grep -A2 <span class="s2">&#34;Subject:&#34;</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">openssl x509 -in ssl/origin.pem -text -noout <span class="p">|</span> grep -A2 <span class="s2">&#34;Validity&#34;</span></span></span></code></pre></div><hr>
<h3 id="security-considerations">Security Considerations</h3>
<h4 id="what-this-setup-protects-against">What This Setup Protects Against</h4>
<table>
  <thead>
      <tr>
          <th>Attack</th>
          <th>Protected?</th>
          <th>How</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>MITM (Browser → Cloudflare)</td>
          <td>✅</td>
          <td>Public SSL certificate</td>
      </tr>
      <tr>
          <td>MITM (Cloudflare → Origin)</td>
          <td>✅</td>
          <td>Origin Certificate + Full (Strict)</td>
      </tr>
      <tr>
          <td>DDoS</td>
          <td>✅</td>
          <td>Cloudflare absorbs attack traffic</td>
      </tr>
      <tr>
          <td>SSL Downgrade</td>
          <td>✅</td>
          <td>HTTPS redirect + HSTS (via Cloudflare)</td>
      </tr>
  </tbody>
</table>
<h4 id="additional-hardening-optional">Additional Hardening (Optional)</h4>
<ol>
<li>
<p><strong>Authenticated Origin Pulls</strong>: Mutual TLS where Cloudflare presents a client certificate</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="ln">1</span><span class="cl"><span class="k">ssl_client_certificate</span> <span class="s">/etc/nginx/ssl/cloudflare-origin-pull.pem</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="k">ssl_verify_client</span> <span class="no">on</span><span class="p">;</span></span></span></code></pre></div></li>
<li>
<p><strong>Restrict Origin to Cloudflare IPs Only</strong>: Configure AWS Security Groups or iptables to only accept connections from <a href="https://www.cloudflare.com/ips/">Cloudflare IP ranges</a></p>
</li>
<li>
<p><strong>Enable HSTS in Cloudflare</strong>: SSL/TLS → Edge Certificates → Always Use HTTPS + HSTS</p>
</li>
</ol>
<hr>
<h3 id="quick-reference">Quick Reference</h3>
<table>
  <thead>
      <tr>
          <th>Task</th>
          <th>Command</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Create SSL directory</td>
          <td><code>mkdir -p ssl</code></td>
      </tr>
      <tr>
          <td>Set key permissions</td>
          <td><code>chmod 600 ssl/origin.key</code></td>
      </tr>
      <tr>
          <td>Build nginx</td>
          <td><code>docker compose build nginx</code></td>
      </tr>
      <tr>
          <td>Deploy nginx only</td>
          <td><code>docker compose up -d --no-deps nginx</code></td>
      </tr>
      <tr>
          <td>Check nginx logs</td>
          <td><code>docker compose logs nginx --tail=50</code></td>
      </tr>
      <tr>
          <td>Test nginx config</td>
          <td><code>docker compose exec nginx nginx -t</code></td>
      </tr>
      <tr>
          <td>Test HTTPS</td>
          <td><code>curl -I https://yourdomain.com</code></td>
      </tr>
  </tbody>
</table>
<hr>
<h3 id="trade-offs-and-limitations">Trade-offs and Limitations</h3>
<p><strong>1. Vendor Lock-in</strong>:
Cloudflare Origin Certificates are not trusted by major browsers, only by Cloudflare. This means you cannot bypass Cloudflare and connect directly to your origin server IP in a browser without getting severe security warnings. If you ever move away from Cloudflare, you will need to replace these certificates with standard ones (e.g., Let&rsquo;s Encrypt).</p>
<p><strong>2. Local Development</strong>:
Since these certificates are for specific public domains, you can&rsquo;t easily use them for <code>localhost</code> development. A common pattern is to have a separate <code>docker-compose.override.yml</code> for local development that overrides the Nginx config to listen on HTTP only or uses mkcert for locally trusted self-signed certificates.</p>
<hr>
<h3 id="conclusion">Conclusion</h3>
<p>With this setup, you now have:</p>
<p>✅ <strong>End-to-end encryption</strong> from browser to origin<br>
✅ <strong>MITM protection</strong> on all network segments<br>
✅ <strong>Zero-cost SSL</strong> with 15-year Cloudflare Origin Certificate<br>
✅ <strong>Rate limiting</strong> and security headers<br>
✅ <strong>Docker-based deployment</strong> for easy management</p>
<p>The key insight is that <strong>Full (Strict) mode</strong> is what provides actual security. Without it, Cloudflare will accept any certificate from your origin, including one presented by an attacker performing a MITM attack.</p>
<hr>
<h3 id="further-reading">Further Reading</h3>
<ul>
<li><a href="https://developers.cloudflare.com/ssl/origin-configuration/origin-ca/">Cloudflare Origin CA certificates</a></li>
<li><a href="https://developers.cloudflare.com/ssl/origin-configuration/ssl-modes/">Cloudflare SSL/TLS encryption modes</a></li>
<li><a href="https://developers.cloudflare.com/ssl/origin-configuration/authenticated-origin-pull/">Authenticated Origin Pulls</a></li>
<li><a href="https://ssl-config.mozilla.org/">Nginx SSL configuration best practices</a></li>
</ul>
]]></content:encoded>
    </item>
    <item>
      <title>MongoDB Connection Pool Exhaustion: Diagnosis, Fixes, and SDAM</title>
      <link>https://KTS-o7.github.io/bear/posts/connection_pool_exhaustion/</link>
      <pubDate>Sat, 06 Dec 2025 12:00:00 +0000</pubDate><author>shentharkrishnatejaswi@gmail.com (Krishnatejaswi S)</author>
      <guid>https://KTS-o7.github.io/bear/posts/connection_pool_exhaustion/</guid>
      <description>&lt;blockquote&gt;&#xA;&lt;p&gt;&lt;strong&gt;Why increasing maxPoolSize breaks your database.&lt;/strong&gt; A deep dive into MongoDB connection pooling, SDAM, WiredTiger tickets, and preventing transaction pinning.&lt;/p&gt;&lt;/blockquote&gt;&#xA;&lt;h2 id=&#34;introduction&#34;&gt;Introduction&lt;/h2&gt;&#xA;&lt;p&gt;In the MongoDB ecosystem, the &amp;ldquo;connection pool&amp;rdquo; is often treated as a set-and-forget configuration within &lt;code&gt;MongoClient&lt;/code&gt;. However, when latency spikes or the database becomes unresponsive during high traffic, the pool is usually the first mechanism to break.&lt;/p&gt;&#xA;&lt;p&gt;Unlike relational databases that often sit behind proxies like PgBouncer, MongoDB drivers are &amp;ldquo;smart&amp;rdquo;—they maintain direct connections to multiple nodes in a Replica Set or Sharded Cluster. This complexity means exhaustion isn&amp;rsquo;t just about running out of sockets; it&amp;rsquo;s about topology monitoring, transaction pinning, and the brutal reality of the thread-per-connection model on the server side.&lt;/p&gt;</description>
      <content:encoded><![CDATA[<blockquote>
<p><strong>Why increasing maxPoolSize breaks your database.</strong> A deep dive into MongoDB connection pooling, SDAM, WiredTiger tickets, and preventing transaction pinning.</p></blockquote>
<h2 id="introduction">Introduction</h2>
<p>In the MongoDB ecosystem, the &ldquo;connection pool&rdquo; is often treated as a set-and-forget configuration within <code>MongoClient</code>. However, when latency spikes or the database becomes unresponsive during high traffic, the pool is usually the first mechanism to break.</p>
<p>Unlike relational databases that often sit behind proxies like PgBouncer, MongoDB drivers are &ldquo;smart&rdquo;—they maintain direct connections to multiple nodes in a Replica Set or Sharded Cluster. This complexity means exhaustion isn&rsquo;t just about running out of sockets; it&rsquo;s about topology monitoring, transaction pinning, and the brutal reality of the thread-per-connection model on the server side.</p>
<h2 id="how-mongodb-connects-and-executes-queries">How MongoDB Connects and Executes Queries</h2>
<p>Before diving into pool exhaustion, it&rsquo;s worth understanding the lifecycle of a MongoDB connection and query. The process is more involved than a simple socket open/close.</p>
<h3 id="connection-establishment">Connection Establishment</h3>
<p>When your application calls <code>MongoClient.connect()</code>, the driver doesn&rsquo;t immediately open a socket. Instead, it:</p>
<ol>
<li>
<p><strong>TCP Socket Creation:</strong> Establishes a TCP/IP connection to the MongoDB server (default port 27017). This is a standard three-way handshake at the network layer.</p>
</li>
<li>
<p><strong>Wire Protocol Handshake:</strong> The client sends a <code>hello</code> command (formerly <code>isMaster</code> in older versions) to the server. This serves multiple purposes:</p>
<ul>
<li>Verifies the server is a MongoDB instance</li>
<li>Retrieves server capabilities (wire protocol version, supported authentication mechanisms)</li>
<li>In MongoDB 4.4+, can include <code>speculativeAuthenticate</code> to start authentication concurrently, reducing latency</li>
</ul>
</li>
<li>
<p><strong>Authentication:</strong> If credentials are provided, the client authenticates using mechanisms like SCRAM (Salted Challenge Response Authentication Mechanism):</p>
<ul>
<li>Client sends <code>saslStart</code> with chosen mechanism and initial payload</li>
<li>Server responds with a challenge</li>
<li>Client computes and sends proof derived from the challenge</li>
<li>Server verifies and grants access</li>
</ul>
</li>
</ol>
<p>This entire process—TCP handshake, TLS negotiation (if enabled), handshake, and authentication—typically takes 10-50ms depending on network latency and encryption overhead.</p>
<h3 id="query-execution-flow">Query Execution Flow</h3>
<p>Once authenticated, the connection is ready for operations. When you execute a query:</p>
<ol>
<li>
<p><strong>Connection Checkout:</strong> The driver checks out a connection from the pool (or waits if none are available—this is where exhaustion manifests).</p>
</li>
<li>
<p><strong>Message Construction:</strong> The query is serialized into MongoDB&rsquo;s wire protocol format. Modern MongoDB uses the <code>OP_MSG</code> opcode (introduced in 3.6), which includes:</p>
<ul>
<li>Standard message header (request ID, response-to ID)</li>
<li>Flags indicating message properties</li>
<li>Sections containing the actual command/query data</li>
<li>Optional checksum for integrity</li>
</ul>
</li>
<li>
<p><strong>Network Transmission:</strong> The message is sent over the TCP socket to the server.</p>
</li>
<li>
<p><strong>Server Processing:</strong> The <code>mongod</code> process:</p>
<ul>
<li>Receives the message on a dedicated thread (in the thread-per-connection model)</li>
<li>Parses the query</li>
<li>Plans execution strategy</li>
<li>Accesses data through WiredTiger (subject to ticket limits)</li>
<li>Creates a cursor for read operations</li>
</ul>
</li>
<li>
<p><strong>Response:</strong> The server sends results back over the same connection. For large result sets, the driver uses cursors to fetch documents in batches (default batch size is 101 documents).</p>
</li>
<li>
<p><strong>Connection Return:</strong> After the operation completes, the connection is returned to the pool for reuse—unless it&rsquo;s pinned to a transaction (see &ldquo;The Specific Pathology: Pinning&rdquo; below).</p>
</li>
</ol>
<h3 id="why-this-matters-for-pooling">Why This Matters for Pooling</h3>
<p>Each of these steps has latency and resource costs. The connection establishment overhead (10-50ms) is why pooling exists: reusing connections avoids paying this cost for every operation. However, the server-side thread allocation means each connection has a real memory and scheduling cost on <code>mongod</code>, which is why blindly increasing pool size backfires.</p>
<h2 id="connection-pool-internals">Connection Pool Internals</h2>
<p>Understanding how the pool manages connections internally is crucial for diagnosing exhaustion. The pool maintains connections in different states:</p>
<h3 id="connection-states">Connection States</h3>
<ol>
<li>
<p><strong>Idle:</strong> Connections that are established and authenticated but not currently in use. These sit in the pool, ready for immediate checkout. They consume server-side resources (thread + memory) but are available for operations.</p>
</li>
<li>
<p><strong>Checked Out:</strong> Connections actively executing an operation. When you call <code>collection.find()</code>, the driver checks out a connection, performs the operation, then returns it to idle—unless it&rsquo;s pinned (see &ldquo;The Specific Pathology: Pinning&rdquo;).</p>
</li>
<li>
<p><strong>Pending:</strong> Connections in the process of being established (TCP handshake, authentication). These don&rsquo;t count toward <code>maxPoolSize</code> until fully established.</p>
</li>
<li>
<p><strong>Closed:</strong> Connections that have been terminated, either due to errors, idle timeout, or explicit closure.</p>
</li>
</ol>
<h3 id="the-wait-queue">The Wait Queue</h3>
<p>When all connections are checked out and the pool has reached <code>maxPoolSize</code>, new requests enter a <strong>wait queue</strong>. This queue has its own limits:</p>
<ul>
<li><strong>waitQueueTimeoutMS:</strong> How long a request waits for a connection before throwing <code>ConnectionPoolCheckoutFailed</code>. Default is 0 (infinite wait—dangerous in production). <strong>Always set this</strong> to fail fast rather than hang indefinitely.</li>
</ul>
<p>If the wait queue fills up, your application starts failing requests. This is often the first symptom of pool exhaustion, not the root cause.</p>
<h3 id="connection-lifecycle">Connection Lifecycle</h3>
<p>The connection lifecycle follows these states and transitions:</p>





<pre tabindex="0"><code>[Not Created]
    │
    │ connect()
    ▼
[Pending] ── TCP handshake, authentication ──► [Idle]
    │                                              │
    │                                              │ Driver request
    │                                              ▼
    │                                        [Checked Out]
    │                                              │
    │                                              │ Operation complete
    │                                              │
    │                                              ▼
    │                                          [Idle] ◄──┐
    │                                              │     │
    │                                              │     │ Return to pool
    │                                              │     │
    │                                              │     │
    │                                              │ startTransaction()
    │                                              ▼     │
    │                                          [Pinned] ──┘
    │                                              │
    │                                              │ ʕ•ᴥ•ʔ DANGEROUS:
    │                                              │ Exclusive to session
    │                                              │ until commit/abort
    │                                              │
    │                                              │ commit/abortTransaction()
    │                                              ▼
    │                                          [Idle]
    │                                              │
    │                                              │ maxIdleTimeMS reached
    │                                              ▼
    │                                          [Closed]
    │                                              │
    └──────────────────────────────────────────────┘</code></pre><p><strong>State Descriptions:</strong></p>
<ul>
<li><strong>Pending:</strong> Connection is being established (TCP handshake, authentication)</li>
<li><strong>Idle:</strong> Connection is established and available in the pool for immediate use</li>
<li><strong>Checked Out:</strong> Connection is actively executing an operation</li>
<li><strong>Pinned:</strong> Connection is reserved for a transaction (removed from pool until transaction completes)</li>
<li><strong>Closed:</strong> Connection has been terminated</li>
</ul>
<p>The pool lazily creates connections up to <code>maxPoolSize</code>. If <code>minPoolSize &gt; 0</code>, it pre-warms that many connections at startup. Connections idle longer than <code>maxIdleTimeMS</code> are closed to free server resources.</p>
<h2 id="sdam-the-hidden-connection-overhead">SDAM: The Hidden Connection Overhead</h2>
<p>MongoDB drivers implement <strong>SDAM</strong> (Server Discovery and Monitoring), which maintains connections to <em>all</em> nodes in a Replica Set or Sharded Cluster, not just the primary.</p>
<h3 id="how-sdam-works">How SDAM Works</h3>
<ol>
<li>
<p><strong>Initial Discovery:</strong> On <code>MongoClient.connect()</code>, the driver connects to seed addresses and sends <code>hello</code> commands to discover all replica set members.</p>
</li>
<li>
<p><strong>Continuous Monitoring:</strong> Every <code>heartbeatFrequencyMS</code> (default 10 seconds), the driver sends <code>hello</code> to each known node to:</p>
<ul>
<li>Detect role changes (primary elections, step-downs)</li>
<li>Check server capabilities</li>
<li>Update topology description</li>
</ul>
</li>
<li>
<p><strong>Topology Events:</strong> When a primary election occurs, the driver:</p>
<ul>
<li>Closes connections to the old primary</li>
<li>Opens connections to the new primary</li>
<li>Potentially drains and recreates pools</li>
</ul>
</li>
</ol>
<h3 id="the-connection-multiplier">The Connection Multiplier</h3>
<p>If you have a 3-node replica set and set <code>maxPoolSize=50</code>, you&rsquo;re not creating 50 connections—you&rsquo;re creating up to <strong>150 connections</strong> (50 per node). SDAM maintains separate pools for each server in the topology.</p>
<p>During a primary election, the driver may temporarily exceed this as it transitions between nodes. If you&rsquo;re running 20 app instances, that&rsquo;s 3,000 potential connections during failover, even if only one node is serving traffic.</p>
<p><strong>Takeaway:</strong> Your <code>maxPoolSize</code> is per-server, not per-client. In replica sets, multiply by the number of nodes you&rsquo;re monitoring.</p>
<h2 id="connection-pool-configuration-options">Connection Pool Configuration Options</h2>
<p>Here are the key options that affect pool behavior:</p>
<ul>
<li>
<p><strong>maxPoolSize:</strong> Maximum connections per server. Default 100. This is the most commonly misconfigured setting.</p>
</li>
<li>
<p><strong>minPoolSize:</strong> Minimum idle connections to maintain. Default 0. Setting this &gt; 0 pre-warms the pool but consumes server resources even when idle.</p>
</li>
<li>
<p><strong>maxIdleTimeMS:</strong> Close idle connections after this duration. Default 0 (never close). Useful in serverless where you want aggressive cleanup.</p>
</li>
<li>
<p><strong>waitQueueTimeoutMS:</strong> How long to wait for a connection before failing. Default 0 (wait forever—dangerous in production). <strong>Always set this</strong> to fail fast rather than hang indefinitely.</p>
</li>
<li>
<p><strong>connectTimeoutMS:</strong> Timeout for initial connection establishment. Default 30 seconds.</p>
</li>
<li>
<p><strong>socketTimeoutMS:</strong> Timeout for individual operations. Default 0 (no timeout). Different from connection checkout timeout.</p>
</li>
<li>
<p><strong>heartbeatFrequencyMS:</strong> How often SDAM checks server status. Default 10 seconds. Lower values detect failovers faster but increase network overhead.</p>
</li>
<li>
<p><strong>TCP Keepalive:</strong> Often overlooked. If your app sits behind a firewall or load balancer (e.g., AWS Network Load Balancer) with a 350s idle timeout, and your pool has <code>maxIdleTimeMS</code> &gt; 350s, the LB will silently drop the connection. The driver won&rsquo;t know until it tries to write to the socket and fails. <strong>Important:</strong> <code>socketTimeoutMS</code> does not send keepalive probes. <strong>Best Practice:</strong> Set <code>maxIdleTimeMS</code> to be slightly lower than your infrastructure&rsquo;s timeout (e.g., 120000ms). On Linux, also tune <code>net.ipv4.tcp_keepalive_time</code> to be less than the cloud provider&rsquo;s timeout (usually &lt; 120 seconds).</p>
</li>
</ul>
<p><strong>Example Configuration (Node.js):</strong></p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="ln">1</span><span class="cl"><span class="kr">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MongoClient</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">  <span class="nx">maxPoolSize</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>              <span class="c1">// Small pool for 16-core DB
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="c1"></span>  <span class="nx">minPoolSize</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>               <span class="c1">// Pre-warm 2 connections
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1"></span>  <span class="nx">maxIdleTimeMS</span><span class="o">:</span> <span class="mi">30000</span><span class="p">,</span>         <span class="c1">// Close idle after 30s
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="c1"></span>  <span class="nx">waitQueueTimeoutMS</span><span class="o">:</span> <span class="mi">5000</span><span class="p">,</span>     <span class="c1">// Fail after 5s wait
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="c1"></span>  <span class="nx">connectTimeoutMS</span><span class="o">:</span> <span class="mi">10000</span><span class="p">,</span>      <span class="c1">// 10s connection timeout
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="c1"></span>  <span class="nx">socketTimeoutMS</span><span class="o">:</span> <span class="mi">45000</span><span class="p">,</span>       <span class="c1">// 45s operation timeout
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="c1"></span>  <span class="nx">heartbeatFrequencyMS</span><span class="o">:</span> <span class="mi">10000</span>   <span class="c1">// Check every 10s
</span></span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="c1"></span><span class="p">});</span></span></span></code></pre></div><h2 id="the-cost-of-a-connection-in-mongod">The Cost of a Connection in mongod</h2>
<p>While MongoDB has moved toward a more asynchronous networking model in recent versions, historically (and effectively, for resource planning), it relies on a synchronous thread-per-connection model.</p>
<p>When your application opens a new connection:</p>
<ol>
<li><strong>Network:</strong> TCP handshake + TLS negotiation (CPU intensive).</li>
<li><strong>Authentication:</strong> SCRAM or X.509 handshakes occur.</li>
<li><strong>Memory:</strong> The <code>mongod</code> process allocates stack memory (typically ~1MB) for the thread handling that connection.</li>
<li><strong>Context:</strong> The internal <code>serviceExecutor</code> must schedule this thread.</li>
</ol>
<p>If you set <code>maxPoolSize=100</code> on 50 Kubernetes pods, you are allowing 5,000 potential concurrent threads on the Primary. Before you hit hardware limits, you will likely hit <strong>WiredTiger ticket exhaustion</strong>.</p>
<h2 id="the-math-sizing-for-wiredtiger">The Math: Sizing for WiredTiger</h2>
<p>The naive approach is to increase <code>maxPoolSize</code> when you see <code>ConnectionPoolCheckoutFailed</code> errors. This is usually wrong.</p>
<p>WiredTiger (the storage engine) uses &ldquo;tickets&rdquo; to control concurrency. In MongoDB versions prior to 7.0, there are 128 read tickets and 128 write tickets by default. MongoDB 7.0+ uses dynamic ticketing that adjusts based on workload, but still caps at 128 per type. <strong>Note on MongoDB 7.0+:</strong> While the hard cap remains 128 tickets, the dynamic algorithm often lowers this limit (e.g., to 60 or 80) in real-time to preserve latency. This means you might see queuing before you hit 128 concurrent active queries. If 1,000 connections try to read simultaneously, 872 of them are just queuing inside the kernel, consuming RAM but doing zero work.</p>
<p>The optimal pool size formula remains tied to hardware capability, not traffic volume:</p>
$$
PoolSize \approx \frac{\text{CoreCount} \times 2}{\text{AppInstances}}
$$<p>If your database has 16 cores and you have 20 application instances, a <code>maxPoolSize</code> of 100 is overkill. You might actually achieve <em>higher</em> throughput with a pool size of 2 or 3 per instance, preventing the database from spending all its cycles on context switching.</p>
<p><strong>Note:</strong> The <code>(Cores * 2)</code> rule applies strictly to the <em>active</em> executing threads. You can have a larger pool to handle network jitter, but <code>waitQueueTimeoutMS</code> is your safety valve. If you need 100 connections to saturate the CPU, your queries are likely too slow (unindexed). Fix the queries, don&rsquo;t inflate the pool.</p>
<p><strong>Workload Considerations:</strong></p>
<ul>
<li><strong>CPU-Bound Workloads:</strong> The formula above applies directly. Each active connection should map to an executing thread.</li>
<li><strong>IO-Bound Workloads:</strong> If the working set doesn&rsquo;t fit in RAM and disk I/O is the bottleneck, a slightly larger pool <em>might</em> help hide I/O latency, though typically <code>minPoolSize</code> is more relevant here to avoid establishing connections during I/O spikes.</li>
<li><strong>Atlas Proxy / Serverless:</strong> If using <strong>MongoDB Atlas Serverless</strong> or the <strong>Atlas Proxy</strong>, the connection limits are handled differently (via a proxy layer), and the &ldquo;100 limit&rdquo; on the client side is less about server stress and more about client-side throttling.</li>
</ul>
<h2 id="the-specific-pathology-pinning">The Specific Pathology: &ldquo;Pinning&rdquo;</h2>
<p>Since you are versed in Mongo, you know the drivers implement the <strong>SDAM</strong> (Server Discovery and Monitoring) specification. But the most dangerous feature regarding pooling is <strong>Client-Side Operation Pinning</strong>, specifically with Transactions.</p>
<p>In a standard read/write, the driver grabs a connection, executes, and returns it.
In a Transaction (Multi-Document ACID):</p>
<ol>
<li><code>session.startTransaction()</code> is called.</li>
<li>The driver <strong>pins</strong> a connection to that session.</li>
<li><strong>That connection is removed from the pool</strong> and reserved exclusively for this session until <code>commitTransaction</code> or <code>abortTransaction</code> is called.</li>
</ol>
<h3 id="the-exhaustion-scenario">The Exhaustion Scenario</h3>
<p>If you have <code>maxPoolSize=50</code> and an API endpoint that takes 2 seconds to execute some logic <em>inside</em> a transaction, you can only serve 25 requests per second. The 26th request will wait. If the logic hangs (e.g., waiting for a third-party HTTP call), you will drain the pool instantly, causing a cascading failure across the app.</p>
<blockquote>
<p><strong>ʕ•ᴥ•ʔ Critical Rule:</strong> Never perform network I/O or long computations inside a MongoDB transaction. Transactions should be atomic, fast, and only contain database operations.</p></blockquote>
<h2 id="practical-examples-the-right-way-vs-the-wrong-way">Practical Examples: The Right Way vs. The Wrong Way</h2>
<h3 id="proper-client-initialization">Proper Client Initialization</h3>
<p><strong>Node.js - Express (Correct):</strong></p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// app.js - Initialize once at startup
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="nx">MongoClient</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="kd">let</span> <span class="nx">client</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="kd">let</span> <span class="nx">db</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="kr">async</span> <span class="kd">function</span> <span class="nx">initDatabase</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">  <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MongoClient</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="nx">maxPoolSize</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="nx">waitQueueTimeoutMS</span><span class="o">:</span> <span class="mi">5000</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">  <span class="kr">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">  <span class="nx">db</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s1">&#39;myapp&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Database connected&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="c1">// Initialize before starting server
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="c1"></span><span class="nx">initDatabase</span><span class="p">().</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">  <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="c1">// Use the same client instance everywhere
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/users&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">  <span class="kr">const</span> <span class="nx">users</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">find</span><span class="p">({}).</span><span class="nx">toArray</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">  <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">users</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="p">});</span></span></span></code></pre></div><p><strong>Node.js - Express (Wrong - Creates New Pool Per Request):</strong></p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// ʕ•̀ω•́ʔ DON&#39;T DO THIS
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="c1"></span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/users&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">  <span class="kr">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MongoClient</span><span class="p">(</span><span class="nx">uri</span><span class="p">);</span>  <span class="c1">// New pool every request!
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1"></span>  <span class="kr">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">  <span class="kr">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s1">&#39;myapp&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">  <span class="kr">const</span> <span class="nx">users</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">find</span><span class="p">({}).</span><span class="nx">toArray</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">7</span><span class="cl">  <span class="kr">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>  <span class="c1">// Closes pool, but too late
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="c1"></span>  <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">users</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="p">});</span></span></span></code></pre></div><p><strong>Python - Gunicorn (Correct):</strong></p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># app.py - Create client after fork</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">MongoClient</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="n">client</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="n">db</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="k">def</span> <span class="nf">on_starting</span><span class="p">(</span><span class="n">server</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="c1"># This runs in the master process</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="k">pass</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="k">def</span> <span class="nf">when_ready</span><span class="p">(</span><span class="n">server</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="c1"># This runs in each worker after fork</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="k">global</span> <span class="n">client</span><span class="p">,</span> <span class="n">db</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="n">client</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">maxPoolSize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">    <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="p">[</span><span class="s1">&#39;myapp&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/users&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="k">def</span> <span class="nf">get_users</span><span class="p">():</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">    <span class="n">users</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">find</span><span class="p">({}))</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">users</span><span class="p">)</span></span></span></code></pre></div><p><strong>Python - Gunicorn (Wrong - Fork-Unsafe):</strong></p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># ʕ•̀ω•́ʔ DON&#39;T DO THIS</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">MongoClient</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="c1"># Created in master process - NOT fork-safe!</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="n">client</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="p">[</span><span class="s1">&#39;myapp&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/users&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="k">def</span> <span class="nf">get_users</span><span class="p">():</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="c1"># Child processes share parent&#39;s file descriptors = deadlocks</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="c1"># This often results in AutoReconnect errors or </span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="c1"># &#39;file descriptor bad&#39; errors because the socket </span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="c1"># is shared across memory boundaries</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="n">users</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">find</span><span class="p">({}))</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">users</span><span class="p">)</span></span></span></code></pre></div><p><strong>Java - Spring Boot:</strong></p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nl">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">  </span><span class="n">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="n">mongodb</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">      </span><span class="n">uri</span><span class="p">:</span><span class="w"> </span><span class="s">&#34;mongodb://user:pass@host1:27017,host2:27017/?replicaSet=myRS&amp;maxPoolSize=10&amp;minPoolSize=2&amp;maxIdleTimeMS=30000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="c1">// Or if using a Configurer Bean (safe way to customize without breaking auto-config)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="nd">@Configuration</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MongoConfig</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">MongoClientSettingsBuilderCustomizer</span><span class="w"> </span><span class="nf">customizer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="na">applyToConnectionPoolSettings</span><span class="p">(</span><span class="n">pool</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">            </span><span class="n">pool</span><span class="p">.</span><span class="na">maxSize</span><span class="p">(</span><span class="n">10</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">            </span><span class="n">pool</span><span class="p">.</span><span class="na">maxWaitTime</span><span class="p">(</span><span class="n">5</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div><p><strong>The Health Check Trap:</strong></p>
<blockquote>
<p><strong>ʕ•ᴥ•ʔ Warning:</strong> Do not create a new <code>MongoClient</code> inside your Kubernetes readiness/liveness probe. This is a classic DOS attack on your own database. The probe runs every 10s; if it creates a new connection each time without proper closure, you will exhaust the server limits in minutes. Use the singleton client to run a lightweight command like <code>db.command({ ping: 1 })</code>.</p></blockquote>
<h3 id="monitoring-pool-metrics">Monitoring Pool Metrics</h3>
<p><strong>Node.js - Command Monitoring:</strong></p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kr">const</span> <span class="p">{</span> <span class="nx">MongoClient</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kr">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MongoClient</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">  <span class="nx">monitorCommands</span><span class="o">:</span> <span class="kc">true</span>  <span class="c1">// Enable command monitoring
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="c1"></span><span class="p">});</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;commandStarted&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Command:&#39;</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">commandName</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;commandSucceeded&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Duration:&#39;</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">duration</span><span class="p">,</span> <span class="s1">&#39;ms&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="c1">// For connection pool metrics, use pool monitoring events
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="c1"></span><span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connectionCheckedOut&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">duration</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// Checkout took &gt; 100ms
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="c1"></span>    <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Slow connection checkout:&#39;</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">duration</span><span class="p">,</span> <span class="s1">&#39;ms&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="nx">client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;commandFailed&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="s1">&#39;ConnectionPoolCheckoutFailed&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Pool exhausted!&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="p">});</span></span></span></code></pre></div><p><strong>Go - Pool Monitoring:</strong></p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">    </span><span class="s">&#34;go.mongodb.org/mongo-driver/event&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="s">&#34;go.mongodb.org/mongo-driver/mongo&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="nx">poolMonitor</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">event</span><span class="p">.</span><span class="nx">PoolMonitor</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nx">Event</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">evt</span><span class="w"> </span><span class="o">*</span><span class="nx">event</span><span class="p">.</span><span class="nx">PoolEvent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="nx">evt</span><span class="p">.</span><span class="nx">Type</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">ConnectionCreated</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Connection created&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">ConnectionCheckedOut</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Connection checked out&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">ConnectionCheckoutFailed</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Checkout failed:&#34;</span><span class="p">,</span><span class="w"> </span><span class="nx">evt</span><span class="p">.</span><span class="nx">Reason</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">ConnectionReturned</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Connection returned&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="p">},</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w"></span><span class="nx">clientOptions</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nf">Client</span><span class="p">().</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="nf">ApplyURI</span><span class="p">(</span><span class="nx">uri</span><span class="p">).</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">    </span><span class="nf">SetPoolMonitor</span><span class="p">(</span><span class="nx">poolMonitor</span><span class="p">).</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span><span class="nf">SetMaxPoolSize</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w"></span><span class="nx">client</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">mongo</span><span class="p">.</span><span class="nf">Connect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span><span class="w"> </span><span class="nx">clientOptions</span><span class="p">)</span></span></span></code></pre></div><h2 id="driver-nuances--pitfalls">Driver Nuances &amp; Pitfalls</h2>
<h3 id="nodejs-mongoose--native-driver">Node.js (Mongoose / Native Driver)</h3>
<p>The Node driver is asynchronous, but the pool logic is strict.</p>
<ul>
<li><strong>The Singleton Mistake:</strong> A common pattern in serverless or improper Express setup is calling <code>MongoClient.connect()</code> inside the route handler. This creates a new pool for every request, rapidly hitting the Atlas connection limit (e.g., 1,500 connections on M10). Always initialize the client <em>once</em> at startup.</li>
<li><strong>Unified Topology:</strong> The Node.js driver (v4.0+) uses Unified Topology by default (it&rsquo;s the only option). This keeps a background monitoring thread that can detect step-downs. If your pool churns during a primary election, check if your <code>heartbeatFrequencyMS</code> is tuned correctly.</li>
</ul>
<h3 id="python-pymongo">Python (PyMongo)</h3>
<ul>
<li><strong>Fork Safety:</strong> <code>MongoClient</code> is not fork-safe. If you use <code>gunicorn</code> or <code>uwsgi</code> with forking, you <strong>must</strong> create the client <em>after</em> the fork (e.g., inside the worker process initialization), or you will end up with child processes trying to use the parent&rsquo;s file descriptors, leading to deadlocks and obscure socket errors. This often manifests as <code>AutoReconnect</code> errors or &ldquo;file descriptor bad&rdquo; errors.</li>
<li><strong>Wait Queue:</strong> In PyMongo 4.0+, <code>waitQueueMultiple</code> was removed. Use <code>waitQueueTimeoutMS</code> to control how long threads wait for connections. Limit your application&rsquo;s thread pool size to control concurrency.</li>
</ul>
<h3 id="java-spring-boot--mongodb-java-driver">Java (Spring Boot / MongoDB Java Driver)</h3>
<ul>
<li><strong>Automatic Pooling:</strong> The <code>MongoTemplate</code> handles pooling automatically. Ensure <code>spring.data.mongodb.database</code> settings do not override defaults with aggressive timeouts. The Java driver&rsquo;s default <code>maxPoolSize</code> is 100, which is often too high for production.</li>
</ul>
<h3 id="go-mongo-go-driver">Go (mongo-go-driver)</h3>
<ul>
<li>The Go driver respects <code>context</code>. If your <code>Connect</code> or <code>Find</code> context times out, the connection might be closed or returned to the pool depending on the stage.</li>
<li>Monitor <code>PoolEvent</code> via the <code>SetPoolMonitor</code> option to visualize exactly when connections are created vs. checked out.</li>
</ul>
<h2 id="serverless--atlas-implications">Serverless &amp; Atlas Implications</h2>
<p>In MongoDB Atlas, connection limits are hard tiers.</p>
<ul>
<li><strong>M0 (Free Tier):</strong> 500 connections per node</li>
<li><strong>M10:</strong> 1,500 connections per node</li>
<li><strong>M20:</strong> 3,000 connections per node</li>
<li><strong>Serverless Instances:</strong> These bill by &ldquo;Read Processing Units&rdquo; but still require connection management.</li>
</ul>
<p>If you are running on AWS Lambda or Vercel, you cannot maintain a persistent pool. Every &ldquo;warm&rdquo; container might keep a pool of 10 open. 100 concurrent Lambdas = 1,000 connections.
<strong>Solution:</strong> You typically cannot use standard pooling here. You must aggressively close connections (set <code>maxIdleTimeMS</code> very low) or use the <strong>Atlas Data API</strong> (HTTP based) instead of the TCP driver to avoid socket exhaustion.</p>
<h2 id="monitoring--diagnosis">Monitoring &amp; Diagnosis</h2>
<p>How do you know it&rsquo;s a pool issue and not a slow query?</p>
<ol>
<li>
<p><strong>Check the Server:</strong></p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="ln">1</span><span class="cl"><span class="nx">db</span><span class="p">.</span><span class="nx">serverStatus</span><span class="p">().</span><span class="nx">connections</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="c1">// look for { &#34;current&#34;: 1200, &#34;available&#34;: 50 }
</span></span></span></code></pre></div><p>If <code>current</code> is high, your app is leaking connections or scaling too wide.</p>
</li>
<li>
<p><strong>Check the Queue:</strong>
Monitor WiredTiger ticket usage via <code>db.serverStatus().wiredTiger.concurrentTransactions</code> or connection counts. If active connections significantly exceed your pool size or WiredTiger tickets are exhausted, your latency is due to queuing, not network speed.</p>
</li>
<li>
<p><strong>Zombie Connections:</strong>
When a client crashes hard (OOM Kill) without sending a TCP FIN, the server keeps the connection open until the server-side <code>tcp_keepalive</code> times out. In high-churn Kubernetes environments, this can exhaust the server&rsquo;s file descriptors even if the <em>active</em> pool count seems low. This reinforces the need for aggressive <code>maxIdleTimeMS</code> and proper TCP keepalive configuration.</p>
</li>
<li>
<p><strong>Driver Metrics:</strong>
Enable command monitoring in your driver. If <code>connectionCheckoutTime</code> spikes while <code>commandDuration</code> (server execution time) stays low, the problem is client-side exhaustion. The database is fast; the line to get to it is slow.</p>
</li>
<li>
<p><strong>Connection Churn Rate:</strong>
Monitor the rate of new connections (<code>connectionsCreated</code> per second). If this is high (&gt;10/sec per node) while your total pool count is stable, your <code>maxIdleTimeMS</code> is likely too low. You are burning server CPU on SSL handshakes rather than reusing connections. Check <code>db.serverStatus().connections.created</code> and compare it to your connection pool turnover rate.</p>
</li>
</ol>
<h2 id="conclusion">Conclusion</h2>
<p>In MongoDB, &ldquo;Connection Pool Exhaustion&rdquo; is often a misnomer for &ldquo;Transaction Pinning&rdquo; or &ldquo;Overscaling.&rdquo; Because the drivers are complex state machines interacting with Replica Sets, simply bumping <code>maxPoolSize</code> masks the problem until it crashes <code>mongod</code> via memory pressure or ticket exhaustion.</p>
<p>The fix is almost always:</p>
<ol>
<li>Lower the pool size to match hardware (<code>threads &lt;= cores</code>).</li>
<li>Shorten transaction scopes to microseconds.</li>
<li>Treat the <code>MongoClient</code> as a sacred singleton.</li>
</ol>
]]></content:encoded>
    </item>
    <item>
      <title>Git</title>
      <link>https://KTS-o7.github.io/bear/posts/git/</link>
      <pubDate>Thu, 04 Dec 2025 00:00:00 +0530</pubDate><author>shentharkrishnatejaswi@gmail.com (Krishnatejaswi S)</author>
      <guid>https://KTS-o7.github.io/bear/posts/git/</guid>
      <description>&lt;h2 id=&#34;git&#34;&gt;Git&lt;/h2&gt;&#xA;&lt;p&gt;Before we start, here&amp;rsquo;s a link to one of the best free books on Git: &lt;a href=&#34;https://git-scm.com/book/en/v2&#34;&gt;Pro Git Book&lt;/a&gt;&lt;/p&gt;&#xA;&lt;hr&gt;&#xA;&lt;h3 id=&#34;what-is-version-control&#34;&gt;What is Version Control?&lt;/h3&gt;&#xA;&lt;p&gt;When working on a project, we often need to keep track of changes made to the code. Version control systems help us track and reconcile changes across different versions of our codebase.&lt;/p&gt;&#xA;&lt;p&gt;Think of your codebase as a tree. Each change you make can create a new branch in the tree. It&amp;rsquo;s up to you to decide if your changes are good enough to become part of the main branch. But why a tree? Because we have a single source of truth (the &lt;code&gt;main&lt;/code&gt; branch) based on which we can reconcile all changes.&lt;/p&gt;</description>
      <content:encoded><![CDATA[<h2 id="git">Git</h2>
<p>Before we start, here&rsquo;s a link to one of the best free books on Git: <a href="https://git-scm.com/book/en/v2">Pro Git Book</a></p>
<hr>
<h3 id="what-is-version-control">What is Version Control?</h3>
<p>When working on a project, we often need to keep track of changes made to the code. Version control systems help us track and reconcile changes across different versions of our codebase.</p>
<p>Think of your codebase as a tree. Each change you make can create a new branch in the tree. It&rsquo;s up to you to decide if your changes are good enough to become part of the main branch. But why a tree? Because we have a single source of truth (the <code>main</code> branch) based on which we can reconcile all changes.</p>
<p>Imagine the source of truth is a single branch called <code>main</code>. When you want to work on a new feature, you create a branch from <code>main</code>, make your changes in that branch, and once you&rsquo;re done, you can merge the branch back into <code>main</code>.</p>
<p>This approach allows us to:</p>
<ol>
<li>Work on multiple features in parallel</li>
<li>Enable multiple people to work on the same codebase simultaneously</li>
<li>Revert to previous stable states if something goes wrong</li>
</ol>
<p><a href="https://mermaid.live/edit#pako:eNp1klFvgjAQx78Kub2ia7GINovJBH3zbU8TH6pchQQoqWWZE7_7KjAjyexT737__92lvQscVILA4ahFlTofUVw69rxvNyIrd85otGj2WpSHtHGW2zUKU2uku140wOEf9nq8bHGCX5irqnGiu_1tr18XB1UUmTn12nCoXd1r_aONWm2B-oiNs-4G7chqQLrcyZxztKPKLM_5C1LpS_lI1k_JsidSSob0kYRPSfSUrAYEXPvgWQLc6BpdsCMX4hbC5eaJwaRYYAzcXhOUos5NDHF5tbZKlJ9KFX9OrepjClyK_GSjukqEwSgT9jeLe1ZjmaAOVV0a4JSwtgjwC3wD9xgbU0KCKQ1oQGaUBC6cgU-mbEymJGABmwXEY97VhZ-2LRmziT-n1GfE8zx_TnwXMMmM0ptukdp9uv4C9ee5ZA"><img src="https://mermaid.ink/img/pako:eNp1klFvgjAQx78Kub2ia7GINovJBH3zbU8TH6pchQQoqWWZE7_7KjAjyexT737__92lvQscVILA4ahFlTofUVw69rxvNyIrd85otGj2WpSHtHGW2zUKU2uku140wOEf9nq8bHGCX5irqnGiu_1tr18XB1UUmTn12nCoXd1r_aONWm2B-oiNs-4G7chqQLrcyZxztKPKLM_5C1LpS_lI1k_JsidSSob0kYRPSfSUrAYEXPvgWQLc6BpdsCMX4hbC5eaJwaRYYAzcXhOUos5NDHF5tbZKlJ9KFX9OrepjClyK_GSjukqEwSgT9jeLe1ZjmaAOVV0a4JSwtgjwC3wD9xgbU0KCKQ1oQGaUBC6cgU-mbEymJGABmwXEY97VhZ-2LRmziT-n1GfE8zx_TnwXMMmM0ptukdp9uv4C9ee5ZA?type=png" alt=""></a></p>
<h3 id="getting-started">Getting Started</h3>
<p>First, download Git from <a href="https://git-scm.com/downloads">here</a> and install it.</p>
<p>In this guide, we&rsquo;ll cover:</p>
<ol>
<li>Setting up Git credentials</li>
<li>Creating a new repository</li>
<li>Understanding the staging area and making commits</li>
<li>Working with branches</li>
<li>Merging branches</li>
<li>Working with remote repositories</li>
<li>Common Git commands and workflows</li>
</ol>
<h4 id="1-setting-up-git-credentials">1. Setting Up Git Credentials</h4>
<p>Before you start using Git, configure your name and email. These will be associated with all your commits.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">git config --global user.name <span class="s2">&#34;Your Name&#34;</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">git config --global user.email <span class="s2">&#34;your.email@example.com&#34;</span></span></span></code></pre></div><p>You can verify your configuration with:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">git config --list</span></span></code></pre></div><h4 id="2-creating-a-new-repository">2. Creating a New Repository</h4>
<p>Navigate to the directory where you want to create the repository. You can either:</p>
<ul>
<li>Initialize an existing directory as a Git repository</li>
<li>Create a new directory and then initialize it</li>
</ul>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># Option 1: Initialize current directory</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">git init
</span></span><span class="line"><span class="ln">3</span><span class="cl">
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1"># Option 2: Create new directory and initialize</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">mkdir my-project
</span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="nb">cd</span> my-project
</span></span><span class="line"><span class="ln">7</span><span class="cl">git init</span></span></code></pre></div><h4 id="3-understanding-the-staging-area-and-making-commits">3. Understanding the Staging Area and Making Commits</h4>
<p>Git uses a three-stage workflow:</p>
<ol>
<li><strong>Working Directory</strong>: Your files as they exist on disk</li>
<li><strong>Staging Area</strong>: Files you&rsquo;ve marked to be included in the next commit</li>
<li><strong>Repository</strong>: Committed snapshots of your project</li>
</ol>
<p>Let&rsquo;s create a file and commit it:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># Create a new file</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Hello, World!&#34;</span> &gt; hello.txt
</span></span><span class="line"><span class="ln">3</span><span class="cl">
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1"># Stage the file (add it to the staging area)</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">git add hello.txt
</span></span><span class="line"><span class="ln">6</span><span class="cl">
</span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="c1"># Commit the changes with a descriptive message</span>
</span></span><span class="line"><span class="ln">8</span><span class="cl">git commit -m <span class="s2">&#34;Add hello.txt file&#34;</span></span></span></code></pre></div><p><strong>Key Commands:</strong></p>
<ul>
<li><code>git status</code> - See which files are modified, staged, or untracked</li>
<li><code>git add &lt;file&gt;</code> - Stage a specific file</li>
<li><code>git add .</code> - Stage all changes in the current directory</li>
<li><code>git commit -m &quot;message&quot;</code> - Commit staged changes with a message</li>
</ul>
<h4 id="4-working-with-branches">4. Working with Branches</h4>
<p>Branches allow you to work on features, experiments, or fixes without affecting the main codebase.</p>
<p><strong>Create and switch to a new branch:</strong></p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">git checkout -b feature1</span></span></code></pre></div><p>This is equivalent to:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">git branch feature1      <span class="c1"># Create the branch</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">git checkout feature1    <span class="c1"># Switch to the branch</span></span></span></code></pre></div><p><strong>Modern alternative (Git 2.23+):</strong></p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">git switch -c feature1   <span class="c1"># Create and switch</span></span></span></code></pre></div><p><strong>Make changes in the new branch:</strong></p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Hello, World! in feature1&#34;</span> &gt; hello.txt</span></span></code></pre></div><p><strong>View all branches:</strong></p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">git branch                <span class="c1"># List local branches</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">git branch -a            <span class="c1"># List all branches (local and remote)</span></span></span></code></pre></div><h4 id="5-committing-changes-to-a-branch">5. Committing Changes to a Branch</h4>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">git add hello.txt
</span></span><span class="line"><span class="ln">2</span><span class="cl">git commit -m <span class="s2">&#34;Update hello.txt in feature1 branch&#34;</span></span></span></code></pre></div><h4 id="6-merging-branches">6. Merging Branches</h4>
<p>Once your feature is complete, merge it back into <code>main</code>:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># Switch back to main branch</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">git checkout main
</span></span><span class="line"><span class="ln">3</span><span class="cl">
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1"># Merge feature1 into main</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">git merge feature1</span></span></code></pre></div><p><strong>Note:</strong> If there are no conflicts, Git will automatically create a merge commit. If conflicts occur, you&rsquo;ll need to resolve them manually.</p>
<h4 id="7-working-with-remote-repositories">7. Working with Remote Repositories</h4>
<p>Remote repositories allow you to collaborate with others and back up your code.</p>
<p><strong>Add a remote repository:</strong></p>
<p>First, create a new repository on a platform like GitHub, GitLab, or Bitbucket. Then copy the repository URL and add it as a remote:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">git remote add origin &lt;remote-repository-URL&gt;</span></span></code></pre></div><p><strong>View remote repositories:</strong></p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">git remote -v              <span class="c1"># List all remotes with URLs</span></span></span></code></pre></div><p><strong>Update remote URL (if needed):</strong></p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">git remote set-url origin &lt;new-URL&gt;</span></span></code></pre></div><h4 id="8-pushing-changes-to-remote">8. Pushing Changes to Remote</h4>
<p>Push your local commits to the remote repository:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">git push -u origin main</span></span></code></pre></div><p>The <code>-u</code> flag sets up tracking, so future pushes can be done with just <code>git push</code>.</p>
<p><strong>Push to a specific branch:</strong></p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">git push origin feature1</span></span></code></pre></div><h4 id="9-pulling-changes-from-remote">9. Pulling Changes from Remote</h4>
<p><code>git pull</code> fetches changes from the remote and merges them into your current branch:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">git pull origin main</span></span></code></pre></div><p><strong>Note:</strong> <code>git pull</code> is equivalent to <code>git fetch</code> followed by <code>git merge</code>.</p>
<h4 id="10-fetching-changes-from-remote">10. Fetching Changes from Remote</h4>
<p><code>git fetch</code> downloads changes from the remote without merging them:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">git fetch origin</span></span></code></pre></div><p>This is useful when you want to see what changes exist on the remote before merging them. After fetching, you can review changes with:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">git log origin/main..main    <span class="c1"># See commits on remote</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">git diff origin/main          <span class="c1"># See differences</span></span></span></code></pre></div><hr>
<h3 id="additional-useful-commands">Additional Useful Commands</h3>
<h4 id="viewing-history-and-changes">Viewing History and Changes</h4>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">git log                      <span class="c1"># View commit history</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">git log --oneline            <span class="c1"># Compact one-line view</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">git log --graph --oneline    <span class="c1"># Visual branch history</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">git diff                     <span class="c1"># See unstaged changes</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">git diff --staged            <span class="c1"># See staged changes</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">git show &lt;commit-hash&gt;       <span class="c1"># Show details of a specific commit</span></span></span></code></pre></div><h4 id="undoing-changes">Undoing Changes</h4>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">git restore &lt;file&gt;           <span class="c1"># Discard changes in working directory</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">git restore --staged &lt;file&gt;  <span class="c1"># Unstage a file</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">git reset HEAD~1             <span class="c1"># Undo last commit (keeps changes)</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">git reset --hard HEAD~1      <span class="c1"># Undo last commit (discards changes) - use with caution!</span></span></span></code></pre></div><h4 id="working-with-gitignore">Working with .gitignore</h4>
<p>Create a <code>.gitignore</code> file to exclude files from version control:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1"># Example .gitignore</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">node_modules/
</span></span><span class="line"><span class="ln">3</span><span class="cl">*.log
</span></span><span class="line"><span class="ln">4</span><span class="cl">.env
</span></span><span class="line"><span class="ln">5</span><span class="cl">.DS_Store</span></span></code></pre></div><h4 id="cloning-a-repository">Cloning a Repository</h4>
<p>To get a copy of an existing repository:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">git clone &lt;repository-URL&gt;</span></span></code></pre></div><p>This creates a new directory with the repository name and downloads all files and history.</p>
<hr>
<h3 id="common-workflows">Common Workflows</h3>
<p><strong>Typical workflow:</strong></p>
<ol>
<li><code>git pull</code> - Get latest changes</li>
<li><code>git checkout -b feature-name</code> - Create feature branch</li>
<li>Make changes and <code>git add</code> files</li>
<li><code>git commit -m &quot;message&quot;</code> - Commit changes</li>
<li><code>git push origin feature-name</code> - Push to remote</li>
<li>Create pull/merge request on platform</li>
<li>After review, merge to main</li>
<li><code>git checkout main &amp;&amp; git pull</code> - Update local main</li>
</ol>
<hr>
<h3 id="tips-and-best-practices">Tips and Best Practices</h3>
<ol>
<li><strong>Write clear commit messages</strong>: Describe what and why, not how</li>
<li><strong>Commit often</strong>: Small, logical commits are easier to review and revert</li>
<li><strong>Pull before push</strong>: Always pull latest changes before pushing</li>
<li><strong>Use branches</strong>: Keep main stable, work on features in branches</li>
<li><strong>Review before merging</strong>: Check your changes with <code>git diff</code> and <code>git status</code></li>
</ol>
]]></content:encoded>
    </item>
    <item>
      <title>Why MySQL is not CA</title>
      <link>https://KTS-o7.github.io/bear/posts/why_mysql_is_not_ca/</link>
      <pubDate>Fri, 05 Sep 2025 07:07:07 +0100</pubDate><author>shentharkrishnatejaswi@gmail.com (Krishnatejaswi S)</author>
      <guid>https://KTS-o7.github.io/bear/posts/why_mysql_is_not_ca/</guid>
      <description>&lt;hr&gt;&#xA;&lt;h2 id=&#34;motivation&#34;&gt;motivation&lt;/h2&gt;&#xA;&lt;p&gt;I was recently discussing with my CTO about databases. There was one point where we were thinking about the &lt;code&gt;CAP&lt;/code&gt; theorem.&#xA;Then he randomly mentioned that MySQL is not CA. I was surprised because I always thought that MySQL is a CA database at its core.&lt;/p&gt;&#xA;&lt;p&gt;Now I had to search and understand why MySQL is not CA.&lt;/p&gt;&#xA;&lt;hr&gt;&#xA;&lt;h2 id=&#34;cap-theorem&#34;&gt;CAP theorem&lt;/h2&gt;&#xA;&lt;p&gt;&lt;img src=&#34;https://substackcdn.com/image/fetch/$s_!cOsx!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F869db2d6-6133-411e-96ad-cc1c52611778_800x472.png&#34; alt=&#34;CAP theorem&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;We have always been taught in Engineering that CAP is one of the most important theorems in distributed systems and databases. We just accepted it. Time to question and learn ┏ʕ •ᴥ•ʔ┛&lt;/p&gt;</description>
      <content:encoded><![CDATA[<hr>
<h2 id="motivation">motivation</h2>
<p>I was recently discussing with my CTO about databases. There was one point where we were thinking about the <code>CAP</code> theorem.
Then he randomly mentioned that MySQL is not CA. I was surprised because I always thought that MySQL is a CA database at its core.</p>
<p>Now I had to search and understand why MySQL is not CA.</p>
<hr>
<h2 id="cap-theorem">CAP theorem</h2>
<p><img src="https://substackcdn.com/image/fetch/$s_!cOsx!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F869db2d6-6133-411e-96ad-cc1c52611778_800x472.png" alt="CAP theorem"></p>
<p>We have always been taught in Engineering that CAP is one of the most important theorems in distributed systems and databases. We just accepted it. Time to question and learn ┏ʕ •ᴥ•ʔ┛</p>
<p>Here is what it actually means.</p>
<p>Imagine a bank server, when you check your account balance it should not randomly change it based on the server you are hitting and it should be consistent across all nodes. But in a distributed system, network failures (partitions) can occur. The CAP theorem states that you can only guarantee 2 out of 3 properties:</p>
<ul>
<li><strong>Consistency (C)</strong>: All nodes see the same data at the same time</li>
<li><strong>Availability (A)</strong>: Every request receives a response, even if it&rsquo;s not the most recent data</li>
<li><strong>Partition Tolerance (P)</strong>: The system continues to operate despite network partitions</li>
</ul>
<p>Here are practical examples of each combination:</p>
<h3 id="ca-systems-consistent--available-but-not-partition-tolerant">CA Systems (Consistent + Available, but not Partition Tolerant)</h3>
<p><code>Example: Traditional Relational Databases (like PostgresSQL in single-node setups)</code></p>
<p>Imagine a single PostgresSQL database server in a bank. When you check your balance:</p>
<ul>
<li><strong>Consistency</strong>: Every time you query your balance, you get the exact same amount ($100.00)</li>
<li><strong>Availability</strong>: The system always responds to your requests</li>
<li><strong>Partition Tolerance</strong>: If the network connection to the database fails, you can&rsquo;t access your account</li>
</ul>
<p>This works perfectly in non-distributed environments, but fails when you need to scale across multiple data centers.</p>
<h3 id="cp-systems-consistent--partition-tolerant-but-sacrifices-availability">CP Systems (Consistent + Partition Tolerant, but sacrifices Availability)</h3>
<p><code>Example: Apache ZooKeeper or etcd</code></p>
<p>Imagine a distributed configuration management system like ZooKeeper:</p>
<ul>
<li><strong>Consistency</strong>: All nodes agree on configuration values (like which server is the leader)</li>
<li><strong>Partition Tolerance</strong>: If some nodes lose network connectivity, the remaining nodes continue operating</li>
<li><strong>Availability</strong>: During a network partition, some requests might be blocked to maintain consistency</li>
</ul>
<p>In a ZooKeeper cluster, if a majority of nodes become unreachable, the system stops accepting writes to prevent inconsistent states.</p>
<h3 id="ap-systems-available--partition-tolerant-but-sacrifices-consistency">AP Systems (Available + Partition Tolerant, but sacrifices Consistency)</h3>
<p><code>Example: Amazon DynamoDB or Cassandra</code></p>
<p>Imagine a social media platform&rsquo;s like counter system:</p>
<ul>
<li><strong>Availability</strong>: The system always responds to requests, even during network failures</li>
<li><strong>Partition Tolerance</strong>: The system continues operating across multiple data centers despite network issues</li>
<li><strong>Consistency</strong>: During partitions, you might see different like counts on different servers</li>
</ul>
<p>You might see a post with 100 likes on one page refresh, then 102 likes on the next refresh, as the systems reconcile the differences asynchronously.</p>
<hr>
<h3 id="why-mysql-is-not-ca">Why MySQL is not CA</h3>
<p>While MySQL can achieve CA in single-node deployments, it cannot be truly CA in distributed scenarios. When you add MySQL replicas or clustering solutions like MySQL Group Replication:</p>
<ul>
<li>During network partitions, MySQL must choose between consistency (rejecting writes) or availability (allowing potentially conflicting writes)</li>
<li>MySQL&rsquo;s synchronous replication can become unavailable during partitions if strict consistency is enforced</li>
<li>Traditional asynchronous replication trades consistency for availability (so it becomes AP, not CA).
Even with semi-sync replication, MySQL typically prioritizes availability over strict consistency—clients may see stale reads.</li>
</ul>
<p>It doesn’t enforce strong ACID guarantees across replicas the way PostgreSQL doe</p>
<h3 id="why-postgresql-is-considered-ca">Why PostgreSQL is considered CA</h3>
<p>Postgres in standalone mode: Definitely CA (strong ACID, always responds if node is up).</p>
<p>In replication setups:</p>
<p>PostgreSQL replication (especially with synchronous replication) prioritizes consistency first.
A commit can be acknowledged only after replicas confirm the write (if you configure synchronous replication).</p>
<p>This means if replicas aren’t reachable, Postgres will prefer not to serve stale data (sacrificing availability to preserve consistency).</p>
<p>So Postgres is effectively CA (or CP in distributed setups).</p>
<p>This is why distributed databases like CockroachDB or TiDB are often preferred for truly distributed, partition-tolerant systems.</p>
<hr>
<p>ʕ ● ᴥ ●ʔ</p>
]]></content:encoded>
    </item>
    <item>
      <title>markdown stuff</title>
      <link>https://KTS-o7.github.io/bear/posts/markdown_stuff/</link>
      <pubDate>Sun, 14 Jan 2024 07:07:07 +0100</pubDate><author>shentharkrishnatejaswi@gmail.com (Krishnatejaswi S)</author>
      <guid>https://KTS-o7.github.io/bear/posts/markdown_stuff/</guid>
      <description>&lt;h2 id=&#34;introduction&#34;&gt;Introduction&lt;/h2&gt;&#xA;&lt;p&gt;This is &lt;strong&gt;bold&lt;/strong&gt; text, and this is &lt;em&gt;emphasized&lt;/em&gt; text.&lt;/p&gt;&#xA;&lt;p&gt;Visit the &lt;a href=&#34;https://gohugo.io&#34;&gt;Hugo&lt;/a&gt; website!&lt;/p&gt;&#xA;&lt;h2 id=&#34;mathematical-examples&#34;&gt;Mathematical Examples&lt;/h2&gt;&#xA;&lt;p&gt;Here are some mathematical expressions rendered using LaTeX:&lt;/p&gt;&#xA;&lt;h3 id=&#34;inline-math&#34;&gt;Inline Math&lt;/h3&gt;&#xA;&lt;p&gt;The quadratic formula is $x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}$.&lt;/p&gt;&#xA;&lt;h3 id=&#34;display-math&#34;&gt;Display Math&lt;/h3&gt;&#xA;&lt;p&gt;The Pythagorean theorem:&#xA;&lt;/p&gt;&#xA;$$&#xA;a^2 + b^2 = c^2&#xA;$$&lt;h3 id=&#34;more-complex-equations&#34;&gt;More Complex Equations&lt;/h3&gt;&#xA;&lt;p&gt;The area of a circle:&#xA;&lt;/p&gt;&#xA;$$&#xA;A = \pi r^2&#xA;$$&lt;p&gt;Integration by parts:&#xA;&lt;/p&gt;&#xA;$$&#xA;\int u \, dv = uv - \int v \, du&#xA;$$&lt;h3 id=&#34;matrices&#34;&gt;Matrices&lt;/h3&gt;&#xA;&lt;p&gt;A simple 2x2 matrix:&#xA;&lt;/p&gt;</description>
      <content:encoded><![CDATA[<h2 id="introduction">Introduction</h2>
<p>This is <strong>bold</strong> text, and this is <em>emphasized</em> text.</p>
<p>Visit the <a href="https://gohugo.io">Hugo</a> website!</p>
<h2 id="mathematical-examples">Mathematical Examples</h2>
<p>Here are some mathematical expressions rendered using LaTeX:</p>
<h3 id="inline-math">Inline Math</h3>
<p>The quadratic formula is $x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}$.</p>
<h3 id="display-math">Display Math</h3>
<p>The Pythagorean theorem:
</p>
$$
a^2 + b^2 = c^2
$$<h3 id="more-complex-equations">More Complex Equations</h3>
<p>The area of a circle:
</p>
$$
A = \pi r^2
$$<p>Integration by parts:
</p>
$$
\int u \, dv = uv - \int v \, du
$$<h3 id="matrices">Matrices</h3>
<p>A simple 2x2 matrix:
</p>
$$
\begin{pmatrix}
a & b \\
c & d
\end{pmatrix}
$$<h3 id="limits-and-derivatives">Limits and Derivatives</h3>
$$
\text{If } f(x) = x^{2}, \text{ then } \frac{d}{dx} (x^{2}) = 2x.
$$<p>Limit as x approaches infinity:
</p>
$$
\lim_{x \to \infty} \frac{1}{x} = 0
$$<h3 id="this-is-how-code-looks-like">This is how code looks like</h3>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln">1</span><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Hello, World!&#34;</span><span class="p">)</span></span></span></code></pre></div><blockquote>
<p>This is a blockquote</p>
<blockquote>
<p>This is a nested blockquote</p>
<blockquote>
<p>This is a nested nested blockquote</p></blockquote></blockquote></blockquote>
<h3 id="this-is-how-a-table-looks-like">This is how a table looks like</h3>
<table>
  <thead>
      <tr>
          <th>Name</th>
          <th>Age</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>John</td>
          <td>25</td>
      </tr>
  </tbody>
</table>
<p><code>inline code</code></p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&#34;en&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">  <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&#34;UTF-8&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">  <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;viewport&#34;</span> <span class="na">content</span><span class="o">=</span><span class="s">&#34;width=device-width, initial-scale=1.0&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Document<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Hello, World!<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span></span></span></code></pre></div>]]></content:encoded>
    </item>
  </channel>
</rss>
